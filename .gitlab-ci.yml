stages:
  - build
  - deploy

image: registry.sh.nextgenwaterprediction.com/infrastructure/docker/docker:latest

variables:
    DOCKER_BUILD_NAME: hydrofabric_api
    DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE
    DOCKER_IMAGE_TAG: $CI_COMMIT_REF_NAME
    ACCESS_KEY: ASIATFZAEDLNGVUWV7HM
    SECRET_ACCESS_KEY: w53CytKzce646v/mp49sPuWDaxakXy2Gzntg9yuQ
    SESSION_TOKEN: IQoJb3JpZ2luX2VjEIX//////////wEaCXVzLWVhc3QtMSJIMEYCIQD1uSXS53P2HS7FCQci+FHTv+RmrWIucillZrhqtW7YsQIhALZ2NMJasc1gXqCyqon9NHylPRi6yUez8/PHBOWdDH3OKp0DCN3//////////wEQABoMMjE4NTczODM5MDY2Igwr/QiDgATS9ZZFpH8q8QKjiGiAe3TNV4xmDrX/uQ8EKfHG+go3/S9AgSzbRz3kWIXtBux2dggpP6bVcJN4AJj6qNV6k3uCX4zaq6pcqYZxgC6BrVtyuGJosqiWYQAIQj+fygwcXk+gPo5UXosedF75k0qsjGRU7pSqXDHUkGvQEPlFeszeJkfYTQUK6Zc2XUfI5rlymwyzzWufNyaMMU9KHSGhOqzBAbDY+7xjtZryJPuUnLE2SF3vCEml6st7oqGDMDqQANhpymJ/i/naT11ZtA3IrguNIQT6lqOfPYRP5K5XFCBHgfRzaJ7CuwCJjK0MVqVyL/i1/nmrqe99agKR5vw+eeuP84cEJr+vetIIsF3Cphcymtk/Q1+V763ekNkexqtczQPGTkSWYLNThQ6myJqQ5Fl/6AYRf9GEtvtUYfHP2SU/Yue8DKctuJ4PKILZf3mJUSEQIllXFdqYhHoDreRcz4aLJ+Nw/MGm9Nzc58YBSwU+ekp2eNPUCk9Q3Tgwj/e1uAY6pQFJ9XJStbO6Kfat9sEk8CsLCZm7srscGD2kUhmUc8vTf+dEAcwgbL0Cz1ywjjBMg796ylLMF70U6ep+bnUErfSkL9Sv+qWnEClw74YJlfFiD7WRxJ8dTqJ66aVrksNQVCcrDPtymSl50+OVoLBJEWEhGDQGMG3pj2dk5GRBGOX8jR0RYE8jgvgw+gtDP85S+OoPZUObNT9zoMr+Rbj2i0HmE/6Nniw=
    DB_PASS: Y2hhbmdlX21l

build:
  stage: build
  script:
    - echo "Building ${CI_PROJECT_NAME} docker image.. "
    - echo "Logging in to Gitlab Container Registry..."
    - echo $CI_JOB_TOKEN | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - apk add --no-cache coreutils aws-cli make sudo
    - export AWS_ACCESS_KEY_ID=$(echo $ACCESS_KEY | base64 -d)
    - export AWS_SECRET_ACCESS_KEY=$(echo $SECRET_ACCESS_KEY | base64 -d)
    - export AWS_SESSION_TOKEN=$(echo $SESSION_TOKEN | base64 -d)
    - export DB_PASSWORD=$(echo $DB_PASS | base64 -d)
    - make get_deps
    - rm -f /tmp/hydro_api/hydrofabric_service_v1.tar
    - rm -f /tmp/hydro_api/hydrofabric_data.tgz
    - docker build --no-cache -t $DOCKER_BUILD_NAME .
    - docker tag $DOCKER_BUILD_NAME:latest $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
    - docker push $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
    - docker logout

deploy:
  stage: deploy
  script:
    - echo "Logging in to Gitlab Container Registry to push the image..."
    - echo $CI_JOB_TOKEN | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - echo "Pushing to the docker registry"
    - docker tag $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG $DOCKER_IMAGE_NAME:latest
    - docker push $DOCKER_IMAGE_NAME:latest
    - docker logout
  rules:
    - if: '$CI_COMMIT_BRANCH == "development"'
